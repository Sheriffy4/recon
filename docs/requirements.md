# Requirements Document

## Introduction

Восстановление и улучшение продвинутого фингерпринтинга DPI является критически важной задачей для повышения качества генерации стратегий обхода. Текущая система использует упрощенную логику анализа, в то время как предыдущая "навороченная" версия имела ML-классификацию с 20+ детальными метриками. Необходимо восстановить утраченный функционал и сделать его еще лучше, обеспечив точное определение типа и поведения DPI-систем для генерации максимально эффективных стратегий обхода.

## Requirements

### Requirement 1: ML-Based DPI Classification System

**User Story:** Как разработчик системы обхода DPI, я хочу иметь ML-классификацию типов DPI-систем, чтобы генерировать наиболее подходящие стратегии обхода для каждого конкретного типа блокировки.

#### Acceptance Criteria

1. WHEN система анализирует сетевой трафик THEN система SHALL использовать sklearn RandomForest для классификации типа DPI
2. WHEN классификация завершена THEN система SHALL возвращать тип DPI с уровнем уверенности (confidence score)
3. WHEN уровень уверенности ниже порогового значения THEN система SHALL запускать дополнительные тесты для уточнения
4. IF DPI-система неизвестна THEN система SHALL создавать новый профиль и обучать модель

### Requirement 2: Comprehensive DPI Metrics Collection

**User Story:** Как система анализа DPI, я хочу собирать 20+ детальных метрик поведения DPI-систем, чтобы создавать точные фингерпринты для каждого типа блокировки.

#### Acceptance Criteria

1. WHEN система проводит анализ THEN система SHALL собирать минимум 20 различных метрик DPI-поведения
2. WHEN анализируется TCP-поведение THEN система SHALL фиксировать паттерны RST-пакетов, таймауты, и манипуляции с заголовками
3. WHEN анализируется HTTP-поведение THEN система SHALL определять методы блокировки (заголовки, содержимое, редиректы)
4. WHEN анализируется DNS-поведение THEN система SHALL выявлять DNS-подмену, блокировку запросов, и фильтрацию ответов
5. WHEN собираются метрики THEN система SHALL сохранять временные характеристики (latency, jitter, packet timing)

### Requirement 3: Persistent Fingerprint Caching System

**User Story:** Как система фингерпринтинга, я хочу кэшировать результаты анализа DPI-систем, чтобы избежать повторного анализа уже известных конфигураций и ускорить работу системы.

#### Acceptance Criteria

1. WHEN фингерпринт DPI создан THEN система SHALL сохранять его в персистентном кэше с TTL
2. WHEN запрашивается анализ известного DPI THEN система SHALL использовать кэшированный фингерпринт
3. WHEN кэшированный фингерпринт устарел THEN система SHALL автоматически обновлять его
4. WHEN обнаружены изменения в поведении DPI THEN система SHALL инвалидировать соответствующий кэш
5. IF кэш поврежден или недоступен THEN система SHALL продолжать работу без кэширования

### Requirement 4: Advanced TCP Behavior Analysis

**User Story:** Как аналитик DPI-систем, я хочу детально анализировать TCP-поведение блокирующих систем, чтобы выявлять специфические паттерны и уязвимости для каждого типа DPI.

#### Acceptance Criteria

1. WHEN анализируется TCP-трафик THEN система SHALL отслеживать паттерны фрагментации пакетов
2. WHEN обнаруживается RST-инъекция THEN система SHALL определять источник и тайминг RST-пакетов
3. WHEN анализируется установка соединения THEN система SHALL фиксировать аномалии в TCP handshake
4. WHEN детектируется манипуляция с окнами THEN система SHALL записывать изменения TCP window size
5. WHEN обнаруживается deep packet inspection THEN система SHALL определять глубину анализа пакетов

### Requirement 5: Enhanced Strategy Generation Integration

**User Story:** Как генератор стратегий обхода, я хочу использовать детальные фингерпринты DPI для создания контекстно-зависимых стратегий, чтобы максимизировать вероятность успешного обхода.

#### Acceptance Criteria

1. WHEN фингерпринт DPI получен THEN генератор стратегий SHALL использовать его для выбора подходящих техник
2. WHEN создается стратегия THEN система SHALL учитывать специфические уязвимости выявленного типа DPI
3. WHEN доступно несколько техник THEN система SHALL ранжировать их по вероятности успеха для данного DPI
4. WHEN стратегия не работает THEN система SHALL обновлять фингерпринт и генерировать альтернативные стратегии
5. IF фингерпринт неполный THEN система SHALL использовать общие стратегии с пометкой о неопределенности

### Requirement 6: Real-time DPI Behavior Monitoring

**User Story:** Как система мониторинга, я хочу отслеживать изменения в поведении DPI-систем в реальном времени, чтобы адаптировать стратегии обхода к эволюции блокирующих систем.

#### Acceptance Criteria

1. WHEN обнаружено изменение в поведении DPI THEN система SHALL обновлять соответствующий фингерпринт
2. WHEN новое поведение не соответствует известным паттернам THEN система SHALL создавать alert для ручного анализа
3. WHEN система работает в фоновом режиме THEN мониторинг SHALL работать с минимальным влиянием на производительность
4. WHEN обнаружена новая техника блокировки THEN система SHALL автоматически тестировать существующие стратегии
5. IF система перегружена THEN мониторинг SHALL снижать частоту проверок для поддержания стабильности

### Requirement 7: Backward Compatibility and Data Migration

**User Story:** Как пользователь системы, я хочу сохранить совместимость с существующими данными и конфигурациями, чтобы обновление до продвинутого фингерпринтинга прошло без потери накопленной информации.

#### Acceptance Criteria

1. WHEN система обновляется THEN существующие кэшированные данные SHALL быть мигрированы в новый формат
2. WHEN используются старые конфигурации THEN система SHALL автоматически конвертировать их в новый формат
3. WHEN миграция невозможна THEN система SHALL создавать резервные копии и начинать с чистого состояния
4. WHEN обнаружены несовместимые данные THEN система SHALL логировать проблемы и продолжать работу
5. IF миграция критически важных данных не удалась THEN система SHALL предупреждать пользователя и предлагать ручное восстановление