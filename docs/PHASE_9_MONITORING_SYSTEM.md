# Фаза 9: Система мониторинга и автоматического восстановления

## Обзор

Фаза 9 добавляет интеллектуальную систему мониторинга, которая непрерывно отслеживает состояние обходов DPI и автоматически восстанавливает соединения при сбоях.

## Ключевые компоненты

### 1. MonitoringSystem
Основная система мониторинга:
- **Непрерывный мониторинг** доступности сайтов
- **Автоматическое восстановление** при сбоях
- **Интеграция с адаптивным обучением** для оптимальных стратегий
- **Гибкая конфигурация** параметров мониторинга

### 2. HealthChecker
Проверка доступности сайтов:
- **HTTP/HTTPS проверки** с поддержкой редиректов
- **TCP connectivity тесты** для базовой доступности
- **Измерение времени отклика** для анализа производительности
- **Обработка различных типов ошибок**

### 3. AutoRecoverySystem
Автоматическое восстановление:
- **Умный выбор стратегий** на основе кэша обучения
- **Предотвращение частых попыток** восстановления
- **Логирование процесса** восстановления
- **Интеграция с BypassEngine** для применения стратегий

### 4. MonitoringWebServer
Веб-интерфейс для управления:
- **Real-time дашборд** с WebSocket обновлениями
- **REST API** для управления сайтами
- **Красивый интерфейс** с адаптивным дизайном
- **Управление конфигурацией** через веб

## Структуры данных

### ConnectionHealth
```python
@dataclass
class ConnectionHealth:
    domain: str                    # Домен сайта
    ip: str                       # IP-адрес
    port: int                     # Порт
    is_accessible: bool           # Доступность
    response_time_ms: float       # Время отклика в мс
    last_check: datetime          # Время последней проверки
    consecutive_failures: int     # Количество подряд идущих сбоев
    last_error: Optional[str]     # Последняя ошибка
    bypass_active: bool           # Активен ли обход
    current_strategy: Optional[str] # Текущая стратегия
```

### MonitoringConfig
```python
@dataclass
class MonitoringConfig:
    check_interval_seconds: int = 30        # Интервал проверок
    failure_threshold: int = 3              # Порог сбоев для восстановления
    recovery_timeout_seconds: int = 300     # Таймаут восстановления
    max_concurrent_checks: int = 10         # Макс. параллельных проверок
    enable_auto_recovery: bool = True       # Включить авто-восстановление
    enable_adaptive_strategies: bool = True # Использовать адаптивные стратегии
    web_interface_port: int = 8080         # Порт веб-интерфейса
    log_level: str = "INFO"                # Уровень логирования
```

## Использование

### 1. Автономный мониторинг
```bash
# Мониторинг конкретных сайтов
python monitor.py rutracker.org kinozal.tv:443

# Мониторинг из файла
python monitor.py -f sites.txt

# Интерактивный режим с live обновлениями
python monitor.py -i rutracker.org

# С веб-интерфейсом
python monitor.py -w rutracker.org
```

### 2. Интеграция с основным CLI
```bash
# Поиск стратегий + мониторинг
python cli.py rutracker.org --monitor

# С веб-интерфейсом
python cli.py rutracker.org --monitor --monitor-web

# Настройка интервала
python cli.py rutracker.org --monitor --monitor-interval 60
```

### 3. Конфигурация
```bash
# Создание конфигурации
cp monitoring_config.example.json monitoring_config.json

# Редактирование параметров
{
  "check_interval_seconds": 30,
  "failure_threshold": 3,
  "enable_auto_recovery": true,
  "web_interface_port": 8080
}
```

## Веб-интерфейс

### Функции дашборда:
- **Real-time статистика** всех мониторимых сайтов
- **Визуальные индикаторы** состояния (зеленый/красный)
- **Метрики производительности** (время отклика, сбои)
- **Управление сайтами** (добавление/удаление)
- **Ручное восстановление** по требованию
- **Конфигурация системы** через веб

### API Endpoints:
```
GET  /api/status              # Общий статус системы
GET  /api/sites               # Список всех сайтов
POST /api/sites               # Добавить сайт
DELETE /api/sites/{domain}    # Удалить сайт
POST /api/recovery/{domain}   # Запустить восстановление
GET  /api/config              # Получить конфигурацию
POST /api/config              # Обновить конфигурацию
GET  /ws                      # WebSocket для real-time обновлений
```

## Алгоритмы мониторинга

### 1. Проверка доступности
```python
async def check_site_health(site_key: str) -> ConnectionHealth:
    # 1. HTTP/HTTPS проверка
    is_accessible, response_time, error = await check_http_connectivity()
    
    # 2. Обновление статистики
    if is_accessible:
        health.consecutive_failures = 0
    else:
        health.consecutive_failures += 1
    
    # 3. Возврат обновленного состояния
    return health
```

### 2. Автоматическое восстановление
```python
async def attempt_recovery(health: ConnectionHealth) -> bool:
    # 1. Проверка частоты попыток
    if too_frequent_attempts():
        return False
    
    # 2. Получение оптимальных стратегий
    strategies = learning_cache.get_smart_strategy_order()
    
    # 3. Тестирование стратегий по порядку
    for strategy in strategies[:3]:
        if await test_strategy_recovery(health, strategy):
            return True
    
    return False
```

### 3. Интеграция с обучением
```python
def get_recovery_strategies(domain: str, ip: str) -> List[str]:
    if learning_cache:
        # Используем накопленные знания
        return learning_cache.get_smart_strategy_order(
            available_strategies, domain, ip
        )
    else:
        # Базовые стратегии
        return default_strategies
```

## Производительность и масштабируемость

### Оптимизации:
- **Асинхронные проверки** всех сайтов параллельно
- **Ограничение concurrent соединений** для предотвращения перегрузки
- **Кэширование DNS** для ускорения проверок
- **Экспоненциальный backoff** при частых сбоях
- **Graceful shutdown** с корректным закрытием соединений

### Масштабируемость:
- Поддержка **сотен сайтов** одновременно
- **Настраиваемые интервалы** проверок
- **Гибкие пороги** для восстановления
- **Модульная архитектура** для расширения

## Интеграция с существующими системами

### 1. Адаптивное обучение
- Использует **накопленные знания** для выбора стратегий
- **Обновляет статистику** успешности восстановлений
- **Оптимизирует порядок** тестирования стратегий

### 2. BypassEngine
- **Автоматически применяет** найденные стратегии
- **Тестирует эффективность** в реальном времени
- **Переключается между стратегиями** при сбоях

### 3. Система отчетности
- **Логирует все события** мониторинга
- **Создает детальные отчеты** о работе системы
- **Интегрируется с веб-интерфейсом** для визуализации

## Примеры использования

### Сценарий 1: Домашний пользователь
```bash
# Простой мониторинг любимых сайтов
python monitor.py rutracker.org kinozal.tv -w

# Открыть http://localhost:8080 в браузере
# Наблюдать за статусом в real-time
```

### Сценарий 2: Системный администратор
```bash
# Мониторинг корпоративных ресурсов
python monitor.py -f corporate_sites.txt -i --interval 60

# Настройка автоматического восстановления
# Интеграция с системами мониторинга
```

### Сценарий 3: Разработчик
```bash
# Тестирование новых стратегий
python cli.py test-site.com --monitor --debug

# Анализ эффективности через веб-интерфейс
# Экспорт данных через API
```

## Безопасность и надежность

### Меры безопасности:
- **Локальный веб-интерфейс** (только localhost)
- **Валидация входных данных** во всех API
- **Ограничение частоты запросов** для предотвращения DoS
- **Безопасное закрытие** всех соединений

### Надежность:
- **Обработка всех исключений** с логированием
- **Graceful degradation** при сбоях компонентов
- **Автоматический restart** при критических ошибках
- **Сохранение состояния** между перезапусками

## Мониторинг и логирование

### Уровни логирования:
- **DEBUG**: Детальная информация о всех операциях
- **INFO**: Основные события (старт/стоп, восстановления)
- **WARNING**: Проблемы, не требующие немедленного вмешательства
- **ERROR**: Критические ошибки, требующие внимания

### Метрики:
- Количество мониторимых сайтов
- Процент доступности
- Среднее время отклика
- Количество успешных восстановлений
- Частота сбоев по сайтам

## Будущие улучшения

### Краткосрочные:
1. **Уведомления** (email, Telegram, Discord)
2. **Экспорт метрик** в Prometheus/Grafana
3. **Мобильная версия** веб-интерфейса
4. **Backup стратегии** для критических сайтов

### Долгосрочные:
1. **Машинное обучение** для предсказания сбоев
2. **Кластерный режим** для высокой доступности
3. **Интеграция с CDN** для глобального мониторинга
4. **API для внешних систем** мониторинга

## Заключение

Фаза 9 превращает статичную систему поиска стратегий в **полноценную платформу мониторинга и управления** обходами DPI. Система обеспечивает:

- **Непрерывный контроль** доступности ресурсов
- **Автоматическое восстановление** при сбоях
- **Удобное управление** через веб-интерфейс
- **Интеграцию с обучением** для оптимальной работы

Это критически важный компонент для продакшн-использования системы обхода DPI в условиях постоянно меняющихся методов блокировки.