# Window Manipulation Attack Specification
# Manipulates TCP window size to confuse DPI systems

name: window_manipulation
aliases:
  - tcp_window_manipulation
  - wssize
  - window_size_manipulation
description: Manipulates TCP window size field to confuse DPI systems that track TCP state
category: tcp_manipulation

parameters:
  - name: window_size
    type: int
    default: 0
    min: 0
    max: 65535
    required: false
    description: TCP window size to advertise (0 = zero window)
  
  - name: window_scale
    type: int
    default: null
    min: 0
    max: 14
    required: false
    description: TCP window scale factor (if specified, adds window scale option)
  
  - name: window_pattern
    type: str
    default: "zero"
    required: false
    description: Window manipulation pattern
    allowed_values:
      - zero
      - minimal
      - random
      - oscillating
      - custom
  
  - name: restore_window
    type: bool
    default: true
    required: false
    description: Whether to restore normal window size after manipulation

expected_packets:
  count: "1 or 2 (depending on restore_window)"
  order:
    - packet_index: 0
      name: manipulated_packet
      properties:
        window_size: "{params.window_size}"
        seq: "{original_seq}"
        tcp_flags: "PSH+ACK (0x18)"
        payload: "original_payload"
        tcp_options: "window_scale option if window_scale specified"
      
    - packet_index: 1
      name: restore_packet
      properties:
        window_size: "{original_window_size}"
        seq: "{original_seq + len(original_payload)}"
        tcp_flags: "ACK (0x10)"
        payload: ""
        condition: "if params.restore_window == True"

validation_rules:
  window_size:
    - rule: "manipulated_packet.window_size == params.window_size"
      description: "Manipulated packet must have specified window size"
      severity: critical
    
    - rule: "manipulated_packet.window_size >= 0 and manipulated_packet.window_size <= 65535"
      description: "Window size must be in valid range"
      severity: critical
    
    - rule: "if params.restore_window: restore_packet.window_size > params.window_size"
      description: "Restore packet should have larger window size"
      severity: warning
  
  tcp_options:
    - rule: "if params.window_scale is not None: 'window_scale' in manipulated_packet.tcp_options"
      description: "Window scale option must be present if specified"
      severity: critical
    
    - rule: "if params.window_scale is not None: manipulated_packet.tcp_options['window_scale'] == params.window_scale"
      description: "Window scale value must match parameter"
      severity: critical
  
  sequence_numbers:
    - rule: "manipulated_packet.seq == original_seq"
      description: "Manipulated packet must have original sequence number"
      severity: critical
    
    - rule: "if params.restore_window: restore_packet.seq == original_seq + len(original_payload)"
      description: "Restore packet sequence must follow manipulated packet"
      severity: critical
  
  payload:
    - rule: "manipulated_packet.payload == original_payload"
      description: "Manipulated packet must have original payload"
      severity: critical
    
    - rule: "if params.restore_window: restore_packet.payload == b''"
      description: "Restore packet should have empty payload"
      severity: warning
  
  packet_count:
    - rule: "if params.restore_window: len(packets) == 2 else len(packets) == 1"
      description: "Packet count must match restore_window setting"
      severity: critical
  
  checksum:
    - rule: "all(p.checksum_valid for p in packets)"
      description: "All packets must have valid checksums"
      severity: critical
  
  ttl:
    - rule: "all(p.ttl in [64, 128] for p in packets)"
      description: "All packets should have default system TTL"
      severity: warning

test_variations:
  zero_window:
    description: "Zero window attack (most common)"
    params:
      window_size: 0
      window_pattern: "zero"
      restore_window: true
  
  minimal_window:
    description: "Minimal window size (1 byte)"
    params:
      window_size: 1
      window_pattern: "minimal"
      restore_window: true
  
  small_window:
    description: "Small window size (256 bytes)"
    params:
      window_size: 256
      restore_window: true
  
  with_window_scale:
    description: "Window manipulation with scale factor"
    params:
      window_size: 0
      window_scale: 7
      restore_window: true
  
  no_restore:
    description: "Window manipulation without restore"
    params:
      window_size: 0
      restore_window: false
  
  random_window:
    description: "Random window size pattern"
    params:
      window_size: 12345
      window_pattern: "random"
      restore_window: true

error_cases:
  negative_window_size:
    description: "window_size cannot be negative"
    params:
      window_size: -1
    expected_error: "window_size must be >= 0"
  
  window_size_too_large:
    description: "window_size exceeds maximum"
    params:
      window_size: 70000
    expected_error: "window_size must be <= 65535"
  
  invalid_window_scale:
    description: "window_scale exceeds maximum"
    params:
      window_size: 0
      window_scale: 15
    expected_error: "window_scale must be <= 14"
  
  negative_window_scale:
    description: "window_scale cannot be negative"
    params:
      window_size: 0
      window_scale: -1
    expected_error: "window_scale must be >= 0"
  
  invalid_window_pattern:
    description: "Invalid window pattern"
    params:
      window_size: 0
      window_pattern: "invalid"
    expected_error: "Unknown window pattern"

notes:
  - "Manipulates TCP window size to confuse DPI flow tracking"
  - "Zero window (window_size=0) is most effective"
  - "DPI systems may not handle zero window correctly"
  - "TCP stack will handle window manipulation correctly"
  - "Window scale option (RFC 1323) can amplify window size"
  - "Window scale factor: actual_window = window_size << window_scale"
  - "Maximum window scale is 14 (window can be up to 1GB)"
  - "restore_window=true sends follow-up packet with normal window"
  - "Restore packet typically has ACK flag only, no payload"
  - "Some DPI systems track window size and may detect manipulation"
  - "Effective against DPI that assumes normal window behavior"
  - "Can be combined with other attacks for better effectiveness"
  - "Window manipulation affects TCP flow control"
  - "Minimal window (1 byte) can also confuse DPI"
  - "Random window sizes can evade pattern detection"

