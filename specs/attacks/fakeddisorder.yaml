# Fakeddisorder Attack Specification
# Combines fake packet with disorder - sends fake packet, then real packets in disorder

name: fakeddisorder
aliases:
  - fakedisorder
  - fake_fakeddisorder
  - tcp_fakeddisorder
  - fake,disorder
  - fake+disorder
  - desync
description: Send fake packet with low TTL, then real packets in out-of-order sequence
category: tcp_manipulation

parameters:
  - name: split_pos
    type: int
    default: 3
    min: 1
    required: true
    description: Position in bytes where to split the real payload
  
  - name: split_seqovl
    type: int
    default: 0
    min: 0
    required: false
    description: Sequence overlap size in bytes (0 = no overlap)
  
  - name: overlap_size
    type: int
    default: 0
    min: 0
    required: false
    description: Alternative parameter name for split_seqovl
  
  - name: ttl
    type: int
    default: 3
    min: 1
    max: 255
    required: false
    description: TTL for fake packet
  
  - name: fake_ttl
    type: int
    default: null
    min: 1
    max: 255
    required: false
    description: Alternative TTL parameter (overrides ttl if specified)
  
  - name: autottl
    type: int
    default: null
    min: 1
    max: 10
    required: false
    description: Auto TTL testing range (tests TTL from 1 to autottl)
  
  - name: fooling
    type: list[str]
    default: ["badsum", "badseq"]
    required: false
    description: Fooling methods to apply to fake packet
    allowed_values:
      - badsum
      - md5sig
      - badseq
      - none
  
  - name: fake_http
    type: str
    default: null
    required: false
    description: Fake HTTP request to send
  
  - name: fake_tls
    type: str
    default: null
    required: false
    description: Fake TLS ClientHello to send (e.g., PAYLOADTLS)
  
  - name: fake_delay_ms
    type: float
    default: 0.0
    min: 0.0
    required: false
    description: Delay in milliseconds before sending fake packet
  
  - name: disorder_delay_ms
    type: float
    default: 1.0
    min: 0.0
    required: false
    description: Delay in milliseconds between disordered packets

expected_packets:
  count: 3
  order:
    - packet_index: 0
      name: fake_packet
      properties:
        ttl: "{ttl or fake_ttl or 3}"
        seq: "{original_seq}"
        tcp_flags: "PSH+ACK (0x18)"
        is_fake: true
        payload: "fake payload (modified or generated)"
        send_order: 1
      
    - packet_index: 1
      name: real_part2
      properties:
        ttl: "64 or 128 (default system TTL)"
        seq: "{original_seq + split_pos - split_seqovl}"
        length: "{len(original_payload) - split_pos}"
        tcp_flags: "PSH+ACK (0x18)"
        is_fake: false
        payload: "original_payload[split_pos:]"
        send_order: 2
      
    - packet_index: 2
      name: real_part1
      properties:
        ttl: "64 or 128 (default system TTL)"
        seq: "{original_seq}"
        length: "{split_pos}"
        tcp_flags: "PSH+ACK (0x18)"
        is_fake: false
        payload: "original_payload[0:split_pos]"
        send_order: 3

validation_rules:
  sequence_numbers:
    - rule: "fake_packet.seq == real_part1.seq"
      description: "CRITICAL: Fake packet must have same sequence number as first real part"
      severity: critical
    
    - rule: "real_part1.seq == original_seq"
      description: "First real part must start at original sequence number"
      severity: critical
    
    - rule: "if params.split_seqovl == 0: real_part2.seq == real_part1.seq + len(real_part1.payload)"
      description: "Without overlap, second part sequence must follow first part"
      severity: critical
    
    - rule: "if params.split_seqovl > 0: real_part2.seq == real_part1.seq + len(real_part1.payload) - params.split_seqovl"
      description: "With overlap, second part sequence must overlap with first part"
      severity: critical
  
  ttl:
    - rule: "fake_packet.ttl == params.ttl or params.fake_ttl"
      description: "Fake packet must have specified TTL"
      severity: critical
    
    - rule: "real_part1.ttl in [64, 128]"
      description: "First real part should have default system TTL"
      severity: warning
    
    - rule: "real_part2.ttl in [64, 128]"
      description: "Second real part should have default system TTL"
      severity: warning
  
  checksum:
    - rule: "if 'badsum' in params.fooling: fake_packet.checksum_valid == False"
      description: "Fake packet must have bad checksum when badsum fooling specified"
      severity: critical
    
    - rule: "real_part1.checksum_valid == True"
      description: "First real part must have valid checksum"
      severity: critical
    
    - rule: "real_part2.checksum_valid == True"
      description: "Second real part must have valid checksum"
      severity: critical
  
  packet_count:
    - rule: "len(packets) == 3"
      description: "Must generate exactly 3 packets"
      severity: critical
  
  packet_order:
    - rule: "packets[0].is_fake == True"
      description: "First packet must be fake"
      severity: critical
    
    - rule: "packets[1].seq > packets[2].seq"
      description: "Real packets must be in disorder (second part before first part)"
      severity: critical
    
    - rule: "packets[1] == real_part2"
      description: "Second sent packet must be second real part"
      severity: critical
    
    - rule: "packets[2] == real_part1"
      description: "Third sent packet must be first real part"
      severity: critical
  
  payload:
    - rule: "real_part1.payload + real_part2.payload == original_payload"
      description: "Combined real payload must equal original (ignoring overlap)"
      severity: critical

test_variations:
  minimal:
    description: "Minimal fakeddisorder with default parameters"
    params:
      split_pos: 3
      ttl: 3
  
  with_overlap:
    description: "Fakeddisorder with sequence overlap"
    params:
      split_pos: 76
      split_seqovl: 336
      ttl: 3
      fooling: ["badsum"]
  
  low_ttl:
    description: "Fakeddisorder with TTL 1"
    params:
      split_pos: 3
      ttl: 1
      fooling: ["badsum", "badseq"]
  
  with_autottl:
    description: "Fakeddisorder with auto TTL testing"
    params:
      split_pos: 3
      autottl: 5
      fooling: ["badsum"]
  
  multiple_fooling:
    description: "Fakeddisorder with multiple fooling methods"
    params:
      split_pos: 3
      ttl: 3
      fooling: ["badsum", "md5sig", "badseq"]
  
  sni_split:
    description: "Fakeddisorder at SNI position for TLS"
    params:
      split_pos: 76
      ttl: 3
      fooling: ["badsum"]

error_cases:
  missing_split_pos:
    description: "split_pos is required"
    params:
      ttl: 3
    expected_error: "split_pos is required"
  
  invalid_ttl:
    description: "TTL must be valid"
    params:
      split_pos: 3
      ttl: 0
    expected_error: "ttl must be between 1 and 255"
  
  negative_overlap:
    description: "Overlap cannot be negative"
    params:
      split_pos: 3
      split_seqovl: -1
    expected_error: "split_seqovl must be >= 0"
  
  invalid_autottl:
    description: "AutoTTL must be in valid range"
    params:
      split_pos: 3
      autottl: 20
    expected_error: "autottl must be between 1 and 10"

notes:
  - "Most complex and effective attack combining fake + disorder"
  - "Fake packet expires before DPI due to low TTL"
  - "Real packets sent in disorder to confuse DPI reassembly"
  - "DPI sees fake packet and allows connection"
  - "Real packets reach destination and are reordered by TCP stack"
  - "CRITICAL: fake_seq must equal original_seq (same as first real part)"
  - "split_seqovl creates sequence overlap for additional confusion"
  - "Default values: split_pos=3, ttl=3, split_seqovl=0"
  - "Zapret compatible with correct sequence overlap logic"
  - "autottl tests multiple TTL values to find optimal"
