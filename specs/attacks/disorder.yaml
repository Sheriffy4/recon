# Disorder Attack Specification
# Sends packet segments in out-of-order sequence

name: disorder
aliases:
  - tcp_disorder
description: Send packet segments in out-of-order sequence to confuse DPI
category: tcp_fragmentation

parameters:
  - name: split_pos
    type: int
    default: null
    min: 1
    required: true
    description: Position in bytes where to split the packet
  
  - name: disorder_delay_ms
    type: float
    default: 1.0
    min: 0.0
    required: false
    description: Delay in milliseconds between disordered packets

expected_packets:
  count: 2
  order:
    - packet_index: 0
      name: second_part
      properties:
        length: "{len(original_payload) - split_pos}"
        seq: "{original_seq + split_pos}"
        tcp_flags: "PSH+ACK (0x18)"
        payload: "original_payload[split_pos:]"
        send_order: 1
      
    - packet_index: 1
      name: first_part
      properties:
        length: "{split_pos}"
        seq: "{original_seq}"
        tcp_flags: "PSH+ACK (0x18)"
        payload: "original_payload[0:split_pos]"
        send_order: 2

validation_rules:
  sequence_numbers:
    - rule: "first_part.seq == original_seq"
      description: "First part must start at original sequence number"
      severity: critical
    
    - rule: "second_part.seq == first_part.seq + len(first_part.payload)"
      description: "Second part sequence must follow first part"
      severity: critical
  
  payload:
    - rule: "first_part.payload + second_part.payload == original_payload"
      description: "Combined payload must equal original"
      severity: critical
    
    - rule: "len(first_part.payload) == params.split_pos"
      description: "First part length must match split position"
      severity: critical
  
  packet_order:
    - rule: "packets[0].seq > packets[1].seq"
      description: "Packets must be sent in reverse sequence order (disorder)"
      severity: critical
    
    - rule: "packets[0] == second_part"
      description: "First sent packet must be second part"
      severity: critical
    
    - rule: "packets[1] == first_part"
      description: "Second sent packet must be first part"
      severity: critical
  
  packet_count:
    - rule: "len(packets) == 2"
      description: "Must generate exactly 2 packets"
      severity: critical
  
  checksum:
    - rule: "all(p.checksum_valid for p in packets)"
      description: "All packets must have valid checksums"
      severity: critical
  
  ttl:
    - rule: "all(p.ttl in [64, 128] for p in packets)"
      description: "All packets should have default system TTL"
      severity: warning

test_variations:
  minimal:
    description: "Disorder with split at position 1"
    params:
      split_pos: 1
  
  early_disorder:
    description: "Disorder with early split"
    params:
      split_pos: 3
  
  middle_disorder:
    description: "Disorder with middle split"
    params:
      split_pos: 50
  
  with_delay:
    description: "Disorder with custom delay"
    params:
      split_pos: 3
      disorder_delay_ms: 5.0
  
  sni_disorder:
    description: "Disorder at SNI position for TLS"
    params:
      split_pos: 76

error_cases:
  missing_split_pos:
    description: "split_pos is required"
    params: {}
    expected_error: "split_pos is required"
  
  zero_split_pos:
    description: "split_pos cannot be 0"
    params:
      split_pos: 0
    expected_error: "split_pos must be >= 1"
  
  negative_split_pos:
    description: "split_pos cannot be negative"
    params:
      split_pos: -1
    expected_error: "split_pos must be >= 1"

notes:
  - "Sends packet segments in reverse order (out-of-order)"
  - "Second part sent first, first part sent second"
  - "TCP stack will reorder packets correctly"
  - "DPI may not handle out-of-order packets correctly"
  - "Both packets have valid checksums and correct sequence numbers"
  - "No TTL manipulation - both packets reach destination"
  - "Disorder confuses DPI signature matching"
