# Requirements Document

## Introduction

Данная спецификация описывает исправление критических проблем в реализации DPI стратегии обхода для проекта recon. На основе анализа PCAP файла выявлены три основные проблемы: неправильные позиции разделения пакетов, отсутствие badsum функциональности и игнорирование SNI позиции для split операций.

## Requirements

### Requirement 1: Исправление логики split-pos

**User Story:** Как разработчик DPI обхода, я хочу, чтобы параметры `--dpi-desync-split-pos=3,10` корректно применялись для разделения пакетов на заданных позициях, чтобы эффективно обходить DPI системы.

#### Acceptance Criteria

1. WHEN пользователь указывает `--dpi-desync-split-pos=3` THEN система SHALL разделять TLS Client Hello пакеты на 3-м байте
2. WHEN пользователь указывает `--dpi-desync-split-pos=10` THEN система SHALL разделять TLS Client Hello пакеты на 10-м байте  
3. WHEN пользователь указывает `--dpi-desync-split-pos=3,10` THEN система SHALL применять обе позиции разделения для разных пакетов
4. WHEN система разделяет пакет THEN первая часть SHALL содержать точно указанное количество байт
5. WHEN система разделяет пакет THEN вторая часть SHALL содержать оставшиеся байты
6. WHEN разделение применяется THEN TCP sequence numbers SHALL быть корректно обновлены для обеих частей
7. IF пакет меньше указанной позиции разделения THEN система SHALL пропустить разделение для этого пакета

### Requirement 2: Реализация badsum функциональности

**User Story:** Как разработчик DPI обхода, я хочу, чтобы параметр `--dpi-desync-fooling=badsum` изменял TCP контрольные суммы на неверные, чтобы обмануть DPI системы, которые проверяют целостность пакетов.

#### Acceptance Criteria

1. WHEN пользователь указывает `--dpi-desync-fooling=badsum` THEN система SHALL изменять TCP checksum на неверный
2. WHEN badsum применяется к пакету THEN оригинальная контрольная сумма SHALL быть заменена на заведомо неверную
3. WHEN badsum применяется THEN неверная контрольная сумма SHALL быть стабильной (не случайной)
4. WHEN система применяет badsum THEN это SHALL применяться только к первой части разделенного пакета
5. IF badsum не указан в параметрах THEN контрольные суммы SHALL оставаться корректными
6. WHEN badsum применяется THEN система SHALL логировать применение этой стратегии
7. WHEN пакет отправляется с badsum THEN сетевой стек SHALL принимать пакет несмотря на неверную сумму

### Requirement 3: Добавление разделения по SNI позиции

**User Story:** Как разработчик DPI обхода, я хочу, чтобы параметр `--dpi-desync-split-pos=sni` разделял TLS Client Hello пакеты точно на позиции SNI extension, чтобы максимально эффективно обходить DPI анализ SNI.

#### Acceptance Criteria

1. WHEN пользователь указывает `--dpi-desync-split-pos=sni` THEN система SHALL определять позицию SNI extension в TLS Client Hello
2. WHEN SNI позиция найдена THEN система SHALL разделять пакет точно на начале SNI extension
3. WHEN SNI не найден в пакете THEN система SHALL пропустить разделение для этого пакета
4. WHEN система находит SNI THEN позиция разделения SHALL быть точно на байте начала SNI extension (тип 0x0000)
5. WHEN разделение по SNI применяется THEN первая часть SHALL содержать TLS заголовки до SNI
6. WHEN разделение по SNI применяется THEN вторая часть SHALL начинаться с SNI extension
7. IF в пакете несколько SNI extensions THEN система SHALL использовать первый найденный SNI

### Requirement 4: Интеграция всех стратегий

**User Story:** Как пользователь системы обхода DPI, я хочу, чтобы все параметры `--dpi-desync=split --dpi-desync-split-pos=sni --dpi-desync-split-pos=3,10 --dpi-desync-fooling=badsum` работали совместно, чтобы получить максимальную эффективность обхода.

#### Acceptance Criteria

1. WHEN указаны множественные split-pos THEN система SHALL применять их к разным пакетам в соединении
2. WHEN указаны sni и числовые позиции THEN система SHALL приоритизировать SNI для TLS пакетов
3. WHEN badsum указан с split THEN badsum SHALL применяться к первой части разделенного пакета
4. WHEN все стратегии активны THEN система SHALL логировать применение каждой стратегии
5. WHEN стратегии конфликтуют THEN система SHALL использовать предопределенный приоритет
6. WHEN пакет не подходит ни под одну стратегию THEN он SHALL проходить без изменений
7. IF применение стратегии невозможно THEN система SHALL fallback к следующей доступной стратегии

### Requirement 5: Валидация и тестирование

**User Story:** Как разработчик, я хочу иметь возможность проверить корректность применения DPI стратегий через анализ PCAP файлов, чтобы убедиться в правильности реализации.

#### Acceptance Criteria

1. WHEN система применяет стратегии THEN результат SHALL быть видим в PCAP анализе
2. WHEN разделение на позиции 3 применено THEN PCAP анализ SHALL показывать пакеты размером 3 байта + остаток
3. WHEN разделение на позиции 10 применено THEN PCAP анализ SHALL показывать пакеты размером 10 байт + остаток  
4. WHEN SNI разделение применено THEN PCAP анализ SHALL показывать разделение на позиции SNI extension
5. WHEN badsum применен THEN PCAP анализ SHALL показывать неверные TCP checksums
6. WHEN стратегии не применяются THEN система SHALL логировать причину
7. WHEN тестирование завершено THEN система SHALL генерировать отчет о применении стратегий