#!/usr/bin/env python3
"""
–ü—Ä—è–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ forced override.
–ù–∞—Ö–æ–¥–∏—Ç –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ—á–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –≤ –∫–æ–¥–µ.
"""

import os
import re
import shutil
from datetime import datetime

def find_strategy_application_points():
    """–ù–∞—Ö–æ–¥–∏—Ç –º–µ—Å—Ç–∞ –≤ –∫–æ–¥–µ, –≥–¥–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏."""
    
    print("üîç –ü–û–ò–°–ö –¢–û–ß–ï–ö –ü–†–ò–ú–ï–ù–ï–ù–ò–Ø –°–¢–†–ê–¢–ï–ì–ò–ô")
    print("=" * 40)
    
    strategy_files = []
    
    # –ò—â–µ–º —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
    for root, dirs, files in os.walk('.'):
        for file in files:
            if file.endswith('.py'):
                file_path = os.path.join(root, file)
                
                try:
                    with open(file_path, 'r', encoding='utf-8') as f:
                        content = f.read()
                    
                    # –ò—â–µ–º –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
                    patterns = [
                        r'apply_bypass',
                        r'strategy.*apply',
                        r'bypass.*strategy',
                        r'no_fallbacks',
                        r'forced.*strategy'
                    ]
                    
                    for pattern in patterns:
                        if re.search(pattern, content, re.IGNORECASE):
                            strategy_files.append(file_path)
                            print(f"‚úÖ –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª —Å–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏: {file_path}")
                            break
                            
                except Exception as e:
                    continue
    
    return list(set(strategy_files))  # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã

def apply_forced_override_patch(file_path):
    """–ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø–∞—Ç—á forced override –∫ —Ñ–∞–π–ª—É."""
    
    print(f"\nüîß –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª: {file_path}")
    
    try:
        # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
        backup_name = f"{file_path}.backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        shutil.copy(file_path, backup_name)
        print(f"‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: {backup_name}")
        
        # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        original_content = content
        
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∑–∞–º–µ–Ω—ã
        replacements = [
            # –î–æ–±–∞–≤–ª—è–µ–º no_fallbacks –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
            (r'(\{[^}]*"type"[^}]*\})', lambda m: add_no_fallbacks_to_config(m.group(1))),
            
            # –î–æ–±–∞–≤–ª—è–µ–º forced override –≤ –≤—ã–∑–æ–≤—ã apply_bypass
            (r'(apply_bypass\([^)]*\))', lambda m: add_forced_to_apply_bypass(m.group(1))),
            
            # –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ forced override
            (r'(logger\.info\([^)]*bypass[^)]*\))', lambda m: add_forced_logging(m.group(1))),
        ]
        
        changes_made = 0
        
        for pattern, replacement in replacements:
            new_content = re.sub(pattern, replacement, content, flags=re.IGNORECASE)
            if new_content != content:
                content = new_content
                changes_made += 1
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é forced override, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        if 'def apply_forced_override' not in content and 'apply_bypass' in content:
            forced_override_function = '''
def apply_forced_override(original_func, *args, **kwargs):
    """
    –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π.
    –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –¥–ª—è –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è —Å —Ä–µ–∂–∏–º–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    """
    # –î–æ–±–∞–≤–ª—è–µ–º forced –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    if len(args) > 1 and isinstance(args[1], dict):
        # –í—Ç–æ—Ä–æ–π –∞—Ä–≥—É–º–µ–Ω—Ç - —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
        strategy = args[1].copy()
        strategy['no_fallbacks'] = True
        strategy['forced'] = True
        args = (args[0], strategy) + args[2:]
        print(f"üî• FORCED OVERRIDE: Applied to {args[0] if args else 'unknown'}")
    
    return original_func(*args, **kwargs)

'''
            # –í—Å—Ç–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞ –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–æ–≤
            import_end = content.find('\n\n')
            if import_end != -1:
                content = content[:import_end] + forced_override_function + content[import_end:]
                changes_made += 1
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª, –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if changes_made > 0:
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(content)
            print(f"‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ {changes_made} –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ {file_path}")
            return True
        else:
            print(f"‚ö†Ô∏è –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è –≤ {file_path}")
            return False
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ {file_path}: {e}")
        return False

def add_no_fallbacks_to_config(config_str):
    """–î–æ–±–∞–≤–ª—è–µ—Ç no_fallbacks –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏."""
    
    if 'no_fallbacks' in config_str:
        return config_str
    
    # –î–æ–±–∞–≤–ª—è–µ–º no_fallbacks: True –≤ JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    if config_str.endswith('}'):
        return config_str[:-1] + ', "no_fallbacks": true, "forced": true}'
    
    return config_str

def add_forced_to_apply_bypass(call_str):
    """–î–æ–±–∞–≤–ª—è–µ—Ç forced –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ –≤—ã–∑–æ–≤ apply_bypass."""
    
    if 'forced' in call_str:
        return call_str
    
    # –î–æ–±–∞–≤–ª—è–µ–º forced=True –≤ –≤—ã–∑–æ–≤
    if call_str.endswith(')'):
        return call_str[:-1] + ', forced=True)'
    
    return call_str

def add_forced_logging(log_str):
    """–î–æ–±–∞–≤–ª—è–µ—Ç FORCED OVERRIDE –≤ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ."""
    
    if 'FORCED OVERRIDE' in log_str:
        return log_str
    
    # –ó–∞–º–µ–Ω—è–µ–º –æ–±—ã—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ forced override
    return log_str.replace('bypass', 'FORCED OVERRIDE bypass')

def create_verification_script():
    """–°–æ–∑–¥–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
    
    verification_script = '''#!/usr/bin/env python3
"""
–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è forced override –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
"""

import os
import re

def verify_forced_override_applied():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ forced override –ø—Ä–∏–º–µ–Ω–µ–Ω."""
    
    print("üîç –ü–†–û–í–ï–†–ö–ê FORCED OVERRIDE –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø")
    print("=" * 50)
    
    # –ò—â–µ–º —Ñ–∞–π–ª—ã —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
    forced_files = []
    
    for root, dirs, files in os.walk('.'):
        for file in files:
            if file.endswith('.py'):
                file_path = os.path.join(root, file)
                
                try:
                    with open(file_path, 'r', encoding='utf-8') as f:
                        content = f.read()
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ forced override
                    if ('no_fallbacks' in content and 'forced' in content) or 'FORCED OVERRIDE' in content:
                        forced_files.append(file_path)
                        
                except Exception:
                    continue
    
    print(f"üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–†–û–í–ï–†–ö–ò:")
    print(f"   ‚úÖ –§–∞–π–ª–æ–≤ —Å forced override: {len(forced_files)}")
    
    if forced_files:
        print(f"\\nüìã –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –§–ê–ô–õ–´:")
        for file_path in forced_files[:10]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 10
            print(f"   üîß {file_path}")
        
        if len(forced_files) > 10:
            print(f"   ... –∏ –µ—â–µ {len(forced_files) - 10} —Ñ–∞–π–ª–æ–≤")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
    backup_files = []
    for root, dirs, files in os.walk('.'):
        for file in files:
            if '.backup_' in file:
                backup_files.append(os.path.join(root, file))
    
    print(f"\\nüíæ –†–ï–ó–ï–†–í–ù–´–ï –ö–û–ü–ò–ò: {len(backup_files)}")
    
    if len(forced_files) > 0:
        print(f"\\n‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ò–ú–ï–ù–ï–ù–û!")
        print("üöÄ –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å —Å–ª—É–∂–±—É")
        print("üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥ –Ω–∞ –∑–∞–ø–∏—Å–∏ 'FORCED OVERRIDE'")
        return True
    else:
        print(f"\\n‚ùå –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ï –ù–ê–ô–î–ï–ù–û!")
        print("üîß –ù—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è")
        return False

if __name__ == "__main__":
    verify_forced_override_applied()
'''
    
    with open('verify_forced_override.py', 'w', encoding='utf-8') as f:
        f.write(verification_script)
    
    print(f"‚úÖ –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏: verify_forced_override.py")

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
    
    print("üîß –ü–†–Ø–ú–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï FORCED OVERRIDE")
    print("=" * 60)
    
    # –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª—ã —Å–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏
    strategy_files = find_strategy_application_points()
    
    if not strategy_files:
        print("‚ùå –§–∞–π–ª—ã —Å–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!")
        return False
    
    print(f"\nüìã –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: {len(strategy_files)}")
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    success_count = 0
    
    for file_path in strategy_files:
        if apply_forced_override_patch(file_path):
            success_count += 1
    
    # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
    create_verification_script()
    
    print(f"\nüìä –ò–¢–û–ì–ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:")
    print(f"   ‚úÖ –£—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: {success_count}/{len(strategy_files)} —Ñ–∞–π–ª–æ–≤")
    
    if success_count > 0:
        print(f"\nüéâ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ò–ú–ï–ù–ï–ù–û!")
        print(f"\nüìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:")
        print("1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:")
        print("   python verify_forced_override.py")
        print("\n2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–ª—É–∂–±—É:")
        print("   python recon_service.py")
        print("\n3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥ –Ω–∞ –∑–∞–ø–∏—Å–∏ 'FORCED OVERRIDE'")
        
        print(f"\nüéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:")
        print("   ‚úÖ –í –ª–æ–≥–µ –∑–∞–ø–∏—Å–∏ 'FORCED OVERRIDE'")
        print("   ‚úÖ YouTube —Ä–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ")
        print("   ‚úÖ –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∫–∞–∫ –≤ —Ä–µ–∂–∏–º–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
        
        return True
    else:
        print(f"\n‚ùå –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ï –ü–†–ò–ú–ï–ù–ï–ù–û!")
        print("üîß –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞")
        return False

if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")