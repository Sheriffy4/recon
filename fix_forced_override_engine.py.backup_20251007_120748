#!/usr/bin/env python3
"""
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ forced override –Ω–∞ —É—Ä–æ–≤–Ω–µ bypass engine.
–î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∫–∞–∫ –≤ —Ä–µ–∂–∏–º–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
"""

import os
import shutil
from datetime import datetime

def find_bypass_engine_files():
    """–ù–∞—Ö–æ–¥–∏—Ç —Ñ–∞–π–ª—ã bypass engine –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
    
    engine_files = []
    
    # –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º bypass engine
    possible_paths = [
        'core/bypass/engine/base_engine.py',
        'core/bypass_engine.py',
        'core/bypass/engine/__init__.py',
        'core/bypass/__init__.py'
    ]
    
    for path in possible_paths:
        if os.path.exists(path):
            engine_files.append(path)
            print(f"‚úÖ –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª engine: {path}")
    
    return engine_files

def apply_forced_override_to_engine():
    """–ü—Ä–∏–º–µ–Ω—è–µ—Ç forced override –∫ bypass engine."""
    
    print("üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï BYPASS ENGINE")
    print("=" * 40)
    
    # –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª—ã engine
    engine_files = find_bypass_engine_files()
    
    if not engine_files:
        print("‚ùå –§–∞–π–ª—ã bypass engine –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!")
        return False
    
    success = False
    
    for engine_file in engine_files:
        print(f"\nüîç –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª: {engine_file}")
        
        try:
            # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
            backup_name = f"{engine_file}.backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
            shutil.copy(engine_file, backup_name)
            print(f"‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: {backup_name}")
            
            # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
            with open(engine_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            if 'no_fallbacks' in content and 'forced' in content:
                print(f"‚ö†Ô∏è –§–∞–π–ª {engine_file} —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç forced override")
                continue
            
            # –î–æ–±–∞–≤–ª—è–µ–º forced override –ª–æ–≥–∏–∫—É
            forced_override_patch = '''
    def set_forced_strategy(self, strategy_config):
        """
        –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∫–∞–∫ –≤ —Ä–µ–∂–∏–º–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
        –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –¥–ª—è –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è.
        """
        self.forced_strategy = strategy_config
        self.logger.info(f"üî• FORCED OVERRIDE: Strategy set to {strategy_config.get('type', 'unknown')}")
        self.logger.info(f"   No fallbacks: {strategy_config.get('no_fallbacks', False)}")
        self.logger.info(f"   Forced: {strategy_config.get('forced', False)}")
    
    def apply_bypass_with_forced_override(self, target_ip, strategy=None):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç bypass —Å forced override –∫–∞–∫ –≤ —Ä–µ–∂–∏–º–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
        """
        if hasattr(self, 'forced_strategy') and self.forced_strategy:
            self.logger.info(f"üî• FORCED OVERRIDE: Applying forced strategy to {target_ip}")
            strategy_to_use = self.forced_strategy
        else:
            strategy_to_use = strategy
        
        return self.apply_bypass_original(target_ip, strategy_to_use)
'''
            
            # –ò—â–µ–º –º–µ—Å—Ç–æ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
            if 'def apply_bypass(' in content:
                # –ó–∞–º–µ–Ω—è–µ–º apply_bypass –Ω–∞ apply_bypass_original
                content = content.replace('def apply_bypass(', 'def apply_bypass_original(')
                
                # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã
                insert_pos = content.find('def apply_bypass_original(')
                if insert_pos != -1:
                    content = content[:insert_pos] + forced_override_patch + '\n    ' + content[insert_pos:]
                    
                    # –ó–∞–º–µ–Ω—è–µ–º –≤—ã–∑–æ–≤—ã apply_bypass –Ω–∞ apply_bypass_with_forced_override
                    content = content.replace('self.apply_bypass(', 'self.apply_bypass_with_forced_override(')
                    
                    success = True
                    print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω forced override –≤ {engine_file}")
            
            elif 'class' in content and 'Engine' in content:
                # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–æ–¥—ã –≤ –∫–ª–∞—Å—Å
                class_end = content.rfind('}')  # –ò—â–µ–º –∫–æ–Ω–µ—Ü –∫–ª–∞—Å—Å–∞
                if class_end == -1:
                    # Python –∫–ª–∞—Å—Å - –∏—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Ç–æ–¥
                    lines = content.split('\n')
                    for i in range(len(lines) - 1, -1, -1):
                        if lines[i].strip().startswith('def ') and not lines[i].strip().startswith('    def '):
                            # –ù–∞—à–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Ç–æ–¥ –∫–ª–∞—Å—Å–∞
                            insert_pos = '\n'.join(lines[:i+1]) + forced_override_patch + '\n' + '\n'.join(lines[i+1:])
                            content = insert_pos
                            success = True
                            print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω forced override –≤ –∫–ª–∞—Å—Å {engine_file}")
                            break
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            if success:
                with open(engine_file, 'w', encoding='utf-8') as f:
                    f.write(content)
                print(f"‚úÖ –§–∞–π–ª {engine_file} –∏—Å–ø—Ä–∞–≤–ª–µ–Ω")
            else:
                print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –º–µ—Å—Ç–æ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ {engine_file}")
                
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ {engine_file}: {e}")
    
    return success

def create_engine_override_test():
    """–°–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ engine override."""
    
    test_script = '''#!/usr/bin/env python3
"""
–¢–µ—Å—Ç forced override –Ω–∞ —É—Ä–æ–≤–Ω–µ bypass engine.
"""

import sys
import os
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
recon_dir = Path(__file__).parent
if str(recon_dir) not in sys.path:
    sys.path.insert(0, str(recon_dir))

def test_engine_forced_override():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç forced override –≤ bypass engine."""
    
    print("üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï ENGINE FORCED OVERRIDE")
    print("=" * 50)
    
    try:
        # –ü—ã—Ç–∞–µ–º—Å—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å bypass engine
        possible_imports = [
            'core.bypass.engine.base_engine',
            'core.bypass_engine',
            'core.bypass.engine'
        ]
        
        engine_class = None
        
        for import_path in possible_imports:
            try:
                module = __import__(import_path, fromlist=[''])
                
                # –ò—â–µ–º –∫–ª–∞—Å—Å engine
                for attr_name in dir(module):
                    attr = getattr(module, attr_name)
                    if (isinstance(attr, type) and 
                        'engine' in attr_name.lower() and 
                        hasattr(attr, '__init__')):
                        engine_class = attr
                        print(f"‚úÖ –ù–∞–π–¥–µ–Ω engine –∫–ª–∞—Å—Å: {attr_name} –∏–∑ {import_path}")
                        break
                
                if engine_class:
                    break
                    
            except ImportError as e:
                print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å {import_path}: {e}")
                continue
        
        if not engine_class:
            print("‚ùå Bypass engine –∫–ª–∞—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω!")
            return False
        
        # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä engine
        try:
            engine = engine_class()
            print(f"‚úÖ –°–æ–∑–¥–∞–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä engine: {type(engine).__name__}")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è engine: {e}")
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ—Ç–æ–¥–æ–≤ forced override
        methods_to_check = [
            'set_forced_strategy',
            'apply_bypass_with_forced_override'
        ]
        
        methods_found = 0
        for method_name in methods_to_check:
            if hasattr(engine, method_name):
                print(f"‚úÖ –ú–µ—Ç–æ–¥ {method_name} –Ω–∞–π–¥–µ–Ω")
                methods_found += 1
            else:
                print(f"‚ùå –ú–µ—Ç–æ–¥ {method_name} –ù–ï –Ω–∞–π–¥–µ–Ω")
        
        if methods_found == len(methods_to_check):
            print(f"\\nüéâ –í–°–ï –ú–ï–¢–û–î–´ FORCED OVERRIDE –ù–ê–ô–î–ï–ù–´!")
            
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É forced strategy
            try:
                test_strategy = {
                    'type': 'fakeddisorder',
                    'params': {'ttl': 4, 'split_pos': 3},
                    'no_fallbacks': True,
                    'forced': True
                }
                
                engine.set_forced_strategy(test_strategy)
                print(f"‚úÖ Forced strategy —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
                
                if hasattr(engine, 'forced_strategy'):
                    print(f"‚úÖ Forced strategy —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ engine")
                    return True
                else:
                    print(f"‚ùå Forced strategy –ù–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞")
                    return False
                    
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ forced strategy: {e}")
                return False
        else:
            print(f"\\n‚ùå –ù–ï –í–°–ï –ú–ï–¢–û–î–´ –ù–ê–ô–î–ï–ù–´ ({methods_found}/{len(methods_to_check)})")
            return False
            
    except Exception as e:
        print(f"‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        return False

if __name__ == "__main__":
    success = test_engine_forced_override()
    
    if success:
        print(f"\\nüéâ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù!")
        print("‚úÖ Engine forced override —Ä–∞–±–æ—Ç–∞–µ—Ç")
        print("üöÄ –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å —Å–ª—É–∂–±—É")
    else:
        print(f"\\n‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù!")
        print("üîß –ù—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è")
'''
    
    with open('test_engine_forced_override.py', 'w', encoding='utf-8') as f:
        f.write(test_script)
    
    print(f"‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç: test_engine_forced_override.py")

if __name__ == "__main__":
    try:
        print("üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï FORCED OVERRIDE –ù–ê –£–†–û–í–ù–ï ENGINE")
        print("=" * 60)
        
        success = apply_forced_override_to_engine()
        
        if success:
            create_engine_override_test()
            
            print(f"\nüéâ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ò–ú–ï–ù–ï–ù–û!")
            print(f"\nüìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:")
            print("1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:")
            print("   python test_engine_forced_override.py")
            print("\n2. –ï—Å–ª–∏ —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–ª—É–∂–±—É:")
            print("   python recon_service.py")
            print("\n3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥ –Ω–∞ –∑–∞–ø–∏—Å–∏ 'FORCED OVERRIDE'")
            
            print(f"\nüéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:")
            print("   ‚úÖ –í –ª–æ–≥–µ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å–∏ 'FORCED OVERRIDE'")
            print("   ‚úÖ YouTube –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –ª—É—á—à–µ")
            print("   ‚úÖ –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ —Ä–µ–∂–∏–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
        else:
            print(f"\n‚ùå –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ï –ü–†–ò–ú–ï–ù–ï–ù–û!")
            print("üîß –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")