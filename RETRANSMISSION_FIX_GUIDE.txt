================================================================================
ИСПРАВЛЕНИЕ ПРОБЛЕМЫ С РЕТРАНСМИССИЯМИ
================================================================================

ПРОБЛЕМА:
---------
Bypass сервис запускается, но заблокированные домены не открываются.
Анализ лога показал, что bypass engine перехватывает TCP ретрансмиссии
вместо первого пакета, что приводит к многократной обработке одного и того
же ClientHello.

ДИАГНОСТИКА:
------------
Запустите: python diagnose_bypass_issue.py

Признаки проблемы:
• Sequence numbers повторяются более 2 раз (например, 12 раз вместо 2)
• Количество применений bypass >> количества уникальных пакетов
• Браузер не получает ответы от серверов

ИСПРАВЛЕНИЕ:
------------
✅ ПРИМЕНЕНО в base_engine.py:

1. Добавлено отслеживание обработанных TCP потоков:
   - self._processed_flows = {}  # {flow_key: timestamp}
   - self._flow_timeout = 60.0   # Таймаут для очистки

2. Добавлена проверка ретрансмиссий в _run_bypass_loop:
   - Перед применением bypass проверяется, не обработан ли уже этот поток
   - Если поток уже обработан → пакет пропускается без bypass
   - Если поток новый → применяется bypass и поток добавляется в словарь

3. Автоматическая очистка старых потоков:
   - Каждые 100 пакетов удаляются потоки старше 60 секунд
   - Предотвращает утечку памяти

КАК ПРОВЕРИТЬ:
--------------
1. Запустите сервис:
   python recon_service.py

2. Откройте заблокированный сайт в браузере (например, x.com)

3. Остановите сервис (Ctrl+C)

4. Проверьте лог:
   python diagnose_bypass_issue.py

ОЖИДАЕМЫЙ РЕЗУЛЬТАТ:
--------------------
✅ Каждый sequence number встречается ровно 2 раза (1 fake + 1 real)
✅ Количество применений bypass = количество уникальных потоков
✅ Ретрансмиссий не обнаружено
✅ Заблокированные домены открываются

ЕСЛИ ПРОБЛЕМА СОХРАНЯЕТСЯ:
--------------------------
1. Проверьте, что исправления применены:
   grep "_processed_flows" core/bypass/engine/base_engine.py

2. Проверьте лог на наличие других ошибок:
   grep "ERROR\|WARNING" log.txt

3. Попробуйте другие bypass стратегии в strategies.json

4. Проверьте, не блокирует ли антивирус WinDivert

================================================================================
